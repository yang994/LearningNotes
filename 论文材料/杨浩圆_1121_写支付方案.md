# WhitePay写支付方案

## 当前流程
  + keeper组对provider挑战获得挑战结果，广播方式同步。选主，根据主节点保存的挑战信息计算时空值st，触发合约进行支付

## 问题和解决方案

### keeper组内如何获得一个共识的时空值并且触发支付

  + 当前流程，只需要提供私钥和userid就可以触发使用支付，不需要对时空值达成共识。
  + 目标：达成一个组内2/3以上节点共识的时空值
  + 用来调用合约触发支付的节点为`leader`，需要支付的时间区间为开始时间`ts`、结束时间`te`，被支付providerid`pid`
  + 在支付过程开始时，leader通过本地保存的挑战信息，计算区间[ts,te)内的时空值`st`,ts从合约中查询，te一般为当前时间。
  + leader对st进行签名`r`，将(ts,te,pid,st,r)发送给组内其他节点。组内其他节点进行验证，根据自己本地的挑战信息，计算自己的时空值`st'`，与st的偏差在一个区间内，则验证通过，对当前leader的时空值进行签名`r'`
  + 若验证不通过，对自己计算的时空值`st''`进行签名`r''`返回(st'',r'')
  + leader需要收到2f+1（包括自己）个`相同`时空值的签名，才可以触发时空支付。此时，触发的支付应该传入(ts,te,st,pid,r1,r2...rn)
  + 在合约中，需要先判断是否收集了足够的签名，传入的时间区间是否合法，再进行签名的聚合验证。验证通过进行支付，返回支付结果,合约对支付结果进行签名。
  + leader将支付结果同步给组内其他节点，组内所有节点都可以对支付结果进行验证。

### 收益与开销
  
  + 原本根据时空值支付的费用应90%给provider，10%为keeper组平分，但是触发支付的leader需要消耗gas，leader应该额外获得不小于gas的费用。
  + 收益的分配，修改为90%Provider，1%leader，9%keeper组平分

### 选主问题 谁来进行支付的触发

  + 目标，选出一个组内共识的leader来触发支付
  + 在一个可信环境下 使用raft中的选主方案（1个user的keeper组，对于一个keeper节点，通信开销为o(n)，keeper节点维护m个user信息，则通信开销为o(mn)，通信开销问题是否需要考虑？）

### 当无法实现时空值的共识

  + leader一直没有收到2f+1以上的时空值签名时，说明此时时空值没有获得共识，此时怎么办。
  + 以一个更短的时间区间发起一次支付，如原区间为[2:00,3:00)没有达成共识，则发起一次[2:00,2:30)的支付
  + 当支付区间小于10m（2次挑战间隔） 还没有达成共识，leader收集其他keeper在当前区间下的挑战信息，计算时空值，然后将时空值、挑战信息以及签名发送给所有keeper进行验证，keeper验证通过后，返回对当前时空值的签名。leader收集2f+1个签名，触发支付。
